<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Password-Protected QR Link Generator</title>
  <meta name="viewport" content="width=600, initial-scale=1.0">
  <!-- Load QRCode.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafd; margin:0;}
    .flex { display: flex; flex-wrap: wrap; align-items: flex-start; justify-content:center; max-width:850px; margin:40px auto;}
    .container { background:#fff; border-radius:12px; box-shadow:0 6px 32px #0002; padding:28px; width:360px; min-width:300px; margin:8px;}
    .qr-side { width:280px; min-width:220px; background:#f4f7fa; border-radius:18px; box-shadow:0 2px 16px #99f2; padding:24px; margin:8px; display:flex; flex-direction:column; align-items:center; }
    h2 { text-align:center; }
    label { font-weight:bold; display:block; margin-top:10px;}
    input[type="text"], input[type="password"] { width:100%;padding:9px;border-radius:6px;border:1px solid #bbb;margin:7px 0 12px 0;}
    button {background:#2e7d32;color:#fff;border:none;padding:10px 24px;font-size:18px;border-radius:6px;cursor:pointer;margin:0 10px 24px 0;}
    button:hover {background:#135b1b;}
    #qrcode, #sideQR {margin:24px auto 10px auto;display:flex;justify-content:center;}
    .note {font-size:13px;color:#777;margin-bottom:16px;}
    #downloadBtn, #viewBtn {display:none;}
    #qr-btns {text-align:center;}
    /* Popup */
    #qrModal {
      display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;
      align-items:center; justify-content:center;
    }
    #qrModalContent {
      background:#fff; border-radius:18px; padding:20px; box-shadow:0 4px 32px #0006; text-align:center;
      position:relative; max-width:95vw;
    }
    #qrModalContent canvas { width:330px !important; height:330px !important;}
    #qrModalClose {
      position:absolute;top:10px;right:20px;font-size:30px;color:#e64a19;cursor:pointer;font-weight:bold;background:none;border:none;
    }
    @media (max-width: 850px) {
      .flex { flex-direction: column; align-items:center; }
      .container, .qr-side { width:95vw; min-width:0; }
      #sideQR { margin:18px auto 10px auto;}
    }
  </style>
</head>
<body>
<div class="flex">
  <div class="container" id="mainGen">
    <h2>QR Code Generator with Password</h2>
    <label>Link/URL to protect:</label>
    <input type="text" id="link" placeholder="https://example.com" autocomplete="off" oninput="liveUpdate()">
    <label>Password to unlock:</label>
    <input type="password" id="pw" placeholder="Set a password" autocomplete="off" oninput="liveUpdate()">
    <div class="note">Auto-preview: Scan the QR, you'll be asked for a password before redirecting.</div>
    <div id="qr-result" style="word-break:break-all;margin-bottom:8px;"></div>
    <div id="qr-btns">
      <button id="viewBtn" onclick="viewQR()">üëÅ View QR</button>
      <button id="downloadBtn" onclick="downloadQR()">‚¨á Download as PNG</button>
    </div>
  </div>

  <div class="qr-side">
    <div style="font-weight:bold;font-size:16px;text-align:center;">Live QR Preview</div>
    <div id="sideQR"><div style="opacity:0.2;font-size:70px;">üü©</div></div>
    <div id="qrMsg" style="text-align:center;color:#888;font-size:13px;">Enter valid link and password</div>
  </div>
</div>

<!-- Modal Popup -->
<div id="qrModal">
  <div id="qrModalContent">
    <button id="qrModalClose" onclick="closeModal()">&times;</button>
    <div id="modalQR"></div>
    <div style="margin-top:12px;color:#777;">Long press or right-click to save</div>
  </div>
</div>

<div class="container" id="pwPrompt" style="display:none;">
  <h2>Password Required</h2>
  <p>Enter the password to access this link.</p>
  <input type="password" id="pwTry" placeholder="Enter password">
  <button onclick="checkPassword()">Unlock</button>
  <div id="pwMsg" style="margin-top:14px;color:#d33;font-weight:bold;"></div>
</div>
<script>
function xorEncrypt(str, key) {
  return btoa([...str].map((c,i)=>String.fromCharCode(c.charCodeAt(0)^key.charCodeAt(i%key.length))).join(''));
}
function xorDecrypt(data, key) {
  try {
    return atob(data).split('').map((c,i)=>String.fromCharCode(c.charCodeAt(0)^key.charCodeAt(i%key.length))).join('');
  } catch {
    return "";
  }
}
let lastURL = '';
function liveUpdate() {
  let link = document.getElementById('link').value.trim();
  let pw = document.getElementById('pw').value;
  let qrValid = /^https?:\/\//i.test(link) && pw.length > 0;
  let sideQR = document.getElementById('sideQR');
  let qrMsg = document.getElementById('qrMsg');
  let qrResult = document.getElementById('qr-result');
  document.getElementById('qr-btns').style.display = qrValid ? "block" : "none";
  document.getElementById('viewBtn').style.display = qrValid ? "inline-block" : "none";
  document.getElementById('downloadBtn').style.display = qrValid ? "inline-block" : "none";

  if (qrValid) {
    let cipher = xorEncrypt(link, pw);
    let url = location.origin + location.pathname + "?q=" + encodeURIComponent(cipher);
    lastURL = url;
    // Render preview QR
    sideQR.innerHTML = "";
    // Wait for QRCode library to load before generating QR
    if (typeof QRCode !== "undefined") {
      QRCode.toCanvas(document.createElement('canvas'), url, {width:200}, (err, canvas) => {
        if (!err && sideQR) sideQR.appendChild(canvas);
      });
    } else {
      sideQR.innerHTML = "<span style='color:#c00;'>QR library failed to load!</span>";
    }
    qrMsg.innerHTML = "<span style='color:#28a745'>QR ready to scan!</span>";
    qrResult.innerHTML = `<b>QR Link:</b> <br><a href="${url}" target="_blank">${url}</a>`;
  } else {
    sideQR.innerHTML = "<div style='opacity:0.2;font-size:70px;'>üü©</div>";
    qrMsg.textContent = "Enter valid link and password";
    qrResult.innerHTML = "";
    lastURL = '';
  }
}
function downloadQR() {
  let canvas = document.querySelector('#sideQR canvas');
  if (!canvas) return alert("No QR generated yet!");
  let link = document.createElement('a');
  link.download = "qr-code.png";
  link.href = canvas.toDataURL();
  link.click();
}
function viewQR() {
  document.getElementById('qrModal').style.display = "flex";
  document.getElementById('modalQR').innerHTML = "";
  if (lastURL && typeof QRCode !== "undefined") {
    QRCode.toCanvas(document.createElement('canvas'), lastURL, {width:330}, (err, canvas) => {
      if (!err) document.getElementById('modalQR').appendChild(canvas);
    });
  }
}
function closeModal() {
  document.getElementById('qrModal').style.display = "none";
}
function checkPassword() {
  let pwTry = document.getElementById("pwTry").value;
  let q = new URLSearchParams(location.search).get("q");
  let link = xorDecrypt(q, pwTry);
  if (/^https?:\/\//i.test(link)) {
    document.getElementById("pwMsg").style.color="#28a745";
    document.getElementById("pwMsg").textContent = "Unlocked! Redirecting‚Ä¶";
    setTimeout(()=>{ location.href=link },900);
  } else {
    document.getElementById("pwMsg").textContent = "Wrong password!";
    document.getElementById("pwMsg").style.color="#d33";
  }
}
if (new URLSearchParams(location.search).get("q")) {
  document.getElementById("mainGen").style.display = "none";
  document.getElementById("pwPrompt").style.display = "block";
}
window.addEventListener('DOMContentLoaded', liveUpdate);
</script>
</body>
</html>
